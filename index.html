<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitLog Pro - App Nativa Local</title>
    <style>
        :root { --p: #2563eb; --bg: #f1f5f9; --txt: #0f172a; --card: #ffffff; --danger: #ef4444; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--txt); margin: 0; padding: 15px; display: flex; justify-content: center; }
        
        .container { width: 100%; max-width: 500px; position: relative; }
        .card { background: var(--card); padding: 1.5rem; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 1rem; }
        
        h2, h3 { margin-top: 0; text-align: center; color: var(--p); }
        input, select, button { width: 100%; padding: 14px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 12px; font-size: 16px; outline: none; }
        
        /* FIX PARA EL CALENDARIO EN IPHONE */
        #calendar-input { 
            width: 100%; 
            max-width: 250px; /* Evita que se estire demasiado */
            margin: 0 auto 15px auto; 
            display: block; 
            text-align: center;
            -webkit-appearance: none; /* Quita estilo nativo de iOS */
            appearance: none;
            cursor: pointer;
        }

        button { background: var(--p); color: white; border: none; font-weight: 700; cursor: pointer; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .btn-sec { background: #64748b; }
        .btn-danger { background: var(--danger); }
        .btn-outline { background: transparent; border: 2px solid var(--p); color: var(--p); }

        /* Navegación de Fecha */
        .date-nav-container { display: flex; align-items: center; justify-content: center; width: 100%; gap: 10px; margin-bottom: 1.5rem; }
        .date-display { flex: 1; max-width: 180px; text-align: center; background: var(--p); color: white; padding: 8px 10px; border-radius: 25px; font-weight: 800; font-size: 1.1rem; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2); }
        .nav-arrow { width: 45px !important; flex-shrink: 0; padding: 8px !important; margin: 0 !important; }

        /* Modales */
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.8); display: flex; align-items: center; justify-content: center; padding: 20px; z-index: 1000; }
        .modal { background: white; padding: 2rem; border-radius: 24px; width: 100%; max-width: 400px; text-align: center; }
        
        /* Asegura que el contenedor no se desborde y distribuya bien el espacio */
        .meal-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 0; 
            border-bottom: 1px solid #f1f5f9;
            gap: 10px; /* Espacio mínimo entre texto y botón */
        }

        /* Controla que el texto no empuje al botón */
        .meal-info { 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; /* Corta el desborde */
            flex: 1; /* Toma todo el espacio disponible menos el del botón */
        }

        /* Fuerza a que los nombres largos salten de línea */
        .meal-info span:first-child {
            word-break: break-word; /* Rompe palabras largas */
            line-height: 1.2;
            margin-bottom: 4px;
        }

        /* Evita que el botón se encoja cuando hay mucho texto */
        .delete-btn { 
            width: auto !important; 
            padding: 8px 12px !important; 
            font-size: 12px; 
            margin: 0 !important; 
            flex-shrink: 0; /* IMPRESCINDIBLE: evita que el texto aplaste al botón */
        }
        .meal-cals { font-weight: 800; color: var(--p); }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <div id="screen-setup" class="hidden">
        <div class="card">
            <h2>Configuración</h2>
            <div id="import-init-area">
                <p style="font-size: 0.9rem; text-align: center; color: #64748b;">¿Tienes una copia de seguridad?</p>
                <button class="btn-outline" onclick="triggerFileSelect()">Importar Datos Existentes</button>
            </div>
            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #e2e8f0;">
            
            <div id="setup-form">
                <label style="font-size: 0.8rem; font-weight: 600;">Sexo</label>
                <select id="sex"><option value="male">Hombre</option><option value="female">Mujer</option></select>
                
                <div id="err-global" class="error-msg">Por favor, rellena todos los campos obligatorios.</div>
                
                <input type="number" id="age" placeholder="Edad (ej: 30)*">
                <input type="number" id="height" placeholder="Altura en cm (ej: 175)*">
                <input type="number" id="weight" placeholder="Peso en kg (ej: 75)*">
                
                <label style="font-size: 0.8rem; font-weight: 600;">Actividad Física</label>
                <select id="activity">
                    <option value="1.2">Sedentario</option>
                    <option value="1.375">Ligero (1-3 días/sem)</option>
                    <option value="1.55">Moderado (3-5 días/sem)</option>
                    <option value="1.725">Intenso (6-7 días/sem)</option>
                </select>
                <button onclick="validateAndSaveProfile('initial')">Empezar a Registrar</button>
            </div>
        </div>
    </div>

    <div id="screen-main" class="hidden">
        <div class="date-nav-container">
            <button class="nav-arrow btn-sec" onclick="changeDate(-1)">◀</button>
            <div class="date-display" id="date-label">HOY</div>
            <button class="nav-arrow btn-sec" id="next-btn" onclick="changeDate(1)">▶</button>
        </div>

        <div class="card" style="text-align: center;">
            <input type="date" id="calendar-input" onchange="jumpToDate(this.value)" style="margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-around;">
                <div><small>Meta Diario</small><div id="tmb-val" style="font-weight: 900; font-size: 1.3rem;">0</div></div>
                <div><small>Balance</small><div id="deficit-val" style="font-weight: 900; font-size: 1.3rem;">0</div></div>
            </div>
        </div>

        <div class="card">
            <h3>Nueva Comida</h3>
            <div style="display: flex; gap: 8px;">
                <input type="text" id="m-name" placeholder="Ej: Cena" style="flex: 2;">
                <input type="number" id="m-cals" placeholder="kcal" style="flex: 1;">
            </div>
            <button onclick="addMeal()">Añadir Registro</button>
        </div>

        <div class="card">
            <div id="meals-list"></div>
            <div style="text-align: right; margin-top: 15px; font-weight: 700;">
                Total: <span id="total-val">0</span> kcal
            </div>
        </div>

        <div class="card">
            <h3>Ajustes</h3>
            <button class="btn-outline" onclick="openProfileFlow('correct')">Corregir Errores de Perfil</button>
            <button class="btn-outline" onclick="openProfileFlow('update')">Actualizar Evolución Física</button>
            <button class="btn-sec" onclick="showConfirm('export')">Exportar Copia (.txt)</button>
            <button class="btn-sec" onclick="showConfirm('import')">Importar Datos</button>
            <button class="btn-danger" onclick="showConfirm('logout')" style="margin-top: 20px;">Cerrar Sesión</button>
        </div>
    </div>

    <div id="modal-container" class="overlay hidden">
        <div class="modal">
            <h3 id="modal-title">Confirmar</h3>
            <p id="modal-body" style="color: #64748b; font-size: 0.95rem; margin-bottom: 20px;"></p>
            <div id="modal-actions">
                </div>
            <button class="btn-sec" onclick="closeModal()" style="margin-top: 8px;">Cancelar</button>
        </div>
    </div>
</div>

<input type="file" id="file-input" class="hidden" accept=".txt" onchange="handleFile(event)">

<script>
    // --- ESTADO Y PERSISTENCIA ---
    let db = JSON.parse(localStorage.getItem('fitlog_db')) || { profiles: [], days: {} };
    
    function getTodayStr() {
        const d = new Date();
        return [d.getFullYear(), String(d.getMonth()+1).padStart(2,'0'), String(d.getDate()).padStart(2,'0')].join('-');
    }

    let activeDateStr = getTodayStr();

    function saveDB() { localStorage.setItem('fitlog_db', JSON.stringify(db)); }

    // --- MANEJO DE PANTALLAS ---
    function showScreen(id) {
        document.getElementById('screen-setup').classList.add('hidden');
        document.getElementById('screen-main').classList.add('hidden');
        document.getElementById(id).classList.remove('hidden');
    }

    // --- VALIDACIÓN Y PERFIL ---
    function validateAndSaveProfile(mode) {
        const err = document.getElementById('err-global');
        const data = {
            sex: document.getElementById('sex').value,
            age: parseInt(document.getElementById('age').value),
            height: parseInt(document.getElementById('height').value),
            weight: parseFloat(document.getElementById('weight').value),
            activity: parseFloat(document.getElementById('activity').value)
        };

        if (!data.age || !data.height || !data.weight || data.age < 1 || data.height < 1 || data.weight < 1) {
            err.innerText = "⚠️ Edad, Altura y Peso son obligatorios y deben ser válidos.";
            err.style.display = 'block';
            return;
        }

        err.style.display = 'none';
        const todayStr = getTodayStr();
        
        if (mode === 'correct') {
            const idx = getProfileIndexForDate(activeDateStr);
            db.profiles[idx] = { ...data, date: db.profiles[idx].date };
        } else {
            // Update o Initial: Si ya hay uno hoy, lo pisa. Si no, añade.
            const existingIdx = db.profiles.findIndex(p => p.date === todayStr);
            if(existingIdx !== -1) db.profiles[existingIdx] = { ...data, date: todayStr };
            else db.profiles.push({ ...data, date: todayStr });
        }

        saveDB();
        location.reload();
    }

    function openProfileFlow(mode) {
        showScreen('screen-setup');
        document.getElementById('import-init-area').classList.add('hidden');
        const idx = getProfileIndexForDate(activeDateStr);
        const p = db.profiles[idx];
        
        document.getElementById('sex').value = p.sex;
        document.getElementById('age').value = p.age;
        document.getElementById('height').value = p.height;
        document.getElementById('weight').value = p.weight;
        document.getElementById('activity').value = p.activity;

        const btnContainer = document.getElementById('setup-form').querySelector('button');
        if(mode === 'correct') {
            btnContainer.innerText = "Guardar Corrección Actual";
            btnContainer.onclick = () => validateAndSaveProfile('correct');
        } else {
            btnContainer.innerText = "Registrar Actualización (Hoy)";
            btnContainer.onclick = () => validateAndSaveProfile('update');
        }
    }

    // --- NAVEGACIÓN DE FECHAS SEGURA ---
    function updateUI() {
        const today = getTodayStr();
        
        // Forzamos el atributo max cada vez que se actualiza la interfaz
        const calendar = document.getElementById('calendar-input');
        calendar.max = today; 
        
        document.getElementById('date-label').innerText = (activeDateStr === today) ? "HOY" : activeDateStr;
        calendar.value = activeDateStr;
        document.getElementById('next-btn').disabled = (activeDateStr >= today);
        
        renderStats();
        renderMeals();
    }

    function changeDate(n) {
        let d = new Date(activeDateStr + "T12:00:00");
        d.setDate(d.getDate() + n);
        const newStr = [d.getFullYear(), String(d.getMonth()+1).padStart(2,'0'), String(d.getDate()).padStart(2,'0')].join('-');
        if(newStr <= getTodayStr()) { activeDateStr = newStr; updateUI(); }
    }

    function jumpToDate(v) { 
        if(!v) return;
        
        const today = getTodayStr();
        // Validación extra para navegadores que ignoran el atributo 'max'
        if (v > today) {
            alert("No puedes registrar comidas en fechas futuras.");
            activeDateStr = today; // Reset a hoy
        } else {
            activeDateStr = v;
        }
        updateUI();
    }
    function getProfileIndexForDate(dateStr) {
        let bestIdx = -1;
        for(let i=0; i<db.profiles.length; i++) {
            if(db.profiles[i].date <= dateStr) {
                if(bestIdx === -1 || db.profiles[i].date > db.profiles[bestIdx].date) bestIdx = i;
            }
        }
        return bestIdx;
    }

    function renderStats() {
        const idx = getProfileIndexForDate(activeDateStr);
        if(idx === -1) return;
        const p = db.profiles[idx];
        let tmb = (10 * p.weight) + (6.25 * p.height) - (5 * p.age);
        tmb = (p.sex === 'male') ? tmb + 5 : tmb - 161;
        const goal = Math.round(tmb * p.activity);
        const consumed = (db.days[activeDateStr] || []).reduce((s,m) => s + m.cals, 0);
        document.getElementById('tmb-val').innerText = goal;
        document.getElementById('total-val').innerText = consumed;
        document.getElementById('deficit-val').innerText = goal - consumed;
        document.getElementById('deficit-val').style.color = (goal - consumed) >= 0 ? "#16a34a" : "var(--danger)";
    }

    function renderMeals() {
        const list = document.getElementById('meals-list');
        list.innerHTML = (db.days[activeDateStr] || []).map((m, i) => `
            <div class="meal-item">
                <div class="meal-info">
                    <span>${m.name}</span>
                    <span class="meal-cals">${m.cals} kcal</span>
                </div>
                <button class="btn-danger delete-btn" onclick="deleteMeal(${i})">Eliminar</button>
            </div>`).join('') || '<p style="text-align:center; color:#94a3b8; font-size: 0.8rem;">Sin comidas registradas</p>';
    }

    function addMeal() {
        const n = document.getElementById('m-name').value;
        const c = parseInt(document.getElementById('m-cals').value);
        if(!n || !c) return;
        if(!db.days[activeDateStr]) db.days[activeDateStr] = [];
        db.days[activeDateStr].push({name: n, cals: c});
        saveDB(); updateUI();
        document.getElementById('m-name').value = ''; document.getElementById('m-cals').value = '';
    }

    function deleteMeal(i) { db.days[activeDateStr].splice(i,1); saveDB(); updateUI(); }

    // --- MODALES Y FLUJOS SIN POP-UPS ---
    function showConfirm(type) {
        const modal = document.getElementById('modal-container');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');
        const actions = document.getElementById('modal-actions');
        
        modal.classList.remove('hidden');
        actions.innerHTML = "";

        if(type === 'logout') {
            title.innerText = "Cerrar Sesión";
            body.innerText = "Se borrarán todos los datos locales. Si no has exportado tu copia de seguridad, los perderás para siempre.";
            actions.innerHTML = `
                <button class="btn-outline" onclick="executeExport()">1. Exportar Ahora</button>
                <button class="btn-danger" onclick="executeLogout()">2. Borrar y Salir</button>
            `;
        } else if(type === 'import') {
            title.innerText = "Importar Datos";
            body.innerText = "Esto reemplazará tus registros actuales. Te recomendamos exportar primero una copia de seguridad.";
            actions.innerHTML = `
                <button class="btn-outline" onclick="executeExport()">Exportar Copia actual</button>
                <button onclick="triggerFileSelect()">Cargar Archivo Nuevo</button>
            `;
        } else if(type === 'export') {
            title.innerText = "Exportar Datos";
            body.innerText = "Se generará un archivo de texto con toda tu base de datos para guardarla fuera del navegador.";
            actions.innerHTML = `<button onclick="executeExport()">Descargar Archivo .txt</button>`;
        }
    }

    function closeModal() { document.getElementById('modal-container').classList.add('hidden'); }

    function executeExport() {
        const data = JSON.stringify(db, null, 2);
        const blob = new Blob([data], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `FitLog_Backup_${getTodayStr()}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        closeModal();
    }

    function triggerFileSelect() { document.getElementById('file-input').click(); }

    function handleFile(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            try {
                const imported = JSON.parse(evt.target.result);
                if(imported.profiles && imported.days) {
                    db = imported;
                    saveDB();
                    location.reload();
                } else { throw new Error(); }
            } catch(e) { 
                const body = document.getElementById('modal-body');
                body.innerText = "❌ Error: El archivo no es válido.";
                body.style.color = "var(--danger)";
            }
        };
        reader.readAsText(file);
    }

    function executeLogout() {
        localStorage.removeItem('fitlog_db');
        location.reload();
    }

    // Inicialización al cargar
    if (db.profiles.length === 0) showScreen('screen-setup');
    else { showScreen('screen-main'); updateUI(); }
</script>

</body>
</html>
